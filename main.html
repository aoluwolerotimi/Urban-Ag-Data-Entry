<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Harvest Tracking</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Innovation Jeunes Onsite Harvest Tracking</h1>

    <!-- Phase 1: Basic Details -->
    <div id="phase-1">
      <h2>Basic Details</h2>
      <div class="mb-3">
        <label for="harvestdate" class="form-label">Harvest date</label>
        <input type="date" class="form-control" id="harvestdate">
      </div>
      <div class="mb-3">
        <label for="source" class="form-label">Source</label>
        <input type="text" class="form-control" id="source">
      </div>
      <div id="crops-container">
        <div class="crop-entry mb-3">
          <label for="crop1" class="form-label">Crop 1</label>
          <input type="text" class="form-control" id="crop1">
          <label for="comments1" class="form-label">Comments</label>
          <input type="text" class="form-control" id="comments1">
        </div>
      </div>
      <button class="btn btn-secondary" onclick="addCrop()">Add Another Crop</button>
      <button class="btn btn-primary" onclick="savePhase(1)">Save</button>
      <button class="btn btn-primary" onclick="nextPhase()">Continue</button>
    </div>

    <!-- Phase 2: Weight Details -->
    <div id="phase-2" class="hidden">
      <h2>Weight Details</h2>
      <div id="weights-container"></div>
      <button class="btn btn-secondary" onclick="previousPhase()">Back</button>
      <button class="btn btn-primary" onclick="savePhase(2)">Save</button>
      <button class="btn btn-primary" onclick="nextPhase()">Continue</button>
    </div>

    <!-- Phase 3: Additional Details -->
    <div id="phase-3" class="hidden">
      <h2>Additional Details</h2>
      <div id="additional-details-container"></div>
      <button class="btn btn-secondary" onclick="previousPhase()">Back</button>
      <button class="btn btn-primary" onclick="savePhase(3)">Save</button>
    </div>
  </div>
  <script>
    let cropCount = 1;
    let currentPhase = 1;
    const harvestData = {
      harvestdate: '',
      source: '',
      crops: []
    };

    function addCrop() {
      cropCount++;
      const cropsContainer = document.getElementById('crops-container');
      const newCropDiv = document.createElement('div');
      newCropDiv.className = 'crop-entry mb-3';
      newCropDiv.innerHTML = `
        <label for="crop${cropCount}" class="form-label">Crop ${cropCount}</label>
        <input type="text" class="form-control" id="crop${cropCount}">
        <label for="comments${cropCount}" class="form-label">Comments</label>
        <input type="text" class="form-control" id="comments${cropCount}">
      `;
      cropsContainer.appendChild(newCropDiv);
    }

    function nextPhase() {
      if (currentPhase === 1) {
        collectPhase1Data();
        showPhase(2);
      } else if (currentPhase === 2) {
        collectPhase2Data();
        showPhase(3);
      }
    }

    function previousPhase() {
      if (currentPhase === 2) {
        showPhase(1);
      } else if (currentPhase === 3) {
        showPhase(2);
      }
    }

    function collectPhase1Data() {
      harvestData.harvestdate = document.getElementById('harvestdate').value;
      harvestData.source = document.getElementById('source').value;
      harvestData.crops = [];
      for (let i = 1; i <= cropCount; i++) {
        const crop = document.getElementById(`crop${i}`).value;
        const comments = document.getElementById(`comments${i}`).value;
        if (crop) {
          harvestData.crops.push({ crop, comments, weight: '', foodTransformation: '', destination: ''});
        }
      }
      renderPhase2();
    }

    function collectPhase2Data() {
      for (let i = 1; i <= cropCount; i++) {
        const weight = document.getElementById(`weight${i}`).value;
        if (harvestData.crops[i-1]) {
          harvestData.crops[i-1].weight = weight;
        }
      }
      renderPhase3();
    }

    function renderPhase2() {
      const weightsContainer = document.getElementById('weights-container');
      weightsContainer.innerHTML = '';
      harvestData.crops.forEach((crop, index) => {
        const cropIndex = index + 1;
        const weightDiv = document.createElement('div');
        weightDiv.className = 'mb-3';
        weightDiv.innerHTML = `
          <label for="weight${cropIndex}" class="form-label">Weight (g) for ${crop.crop}</label>
          <input type="number" class="form-control" id="weight${cropIndex}" min="1">
        `;
        weightsContainer.appendChild(weightDiv);
      });
    }

    function renderPhase3() {
      const additionalDetailsContainer = document.getElementById('additional-details-container');
      additionalDetailsContainer.innerHTML = '';
      harvestData.crops.forEach((crop, index) => {
        const cropIndex = index + 1;
        const detailsDiv = document.createElement('div');
        detailsDiv.className = 'mb-3';
        detailsDiv.innerHTML = `
          <label for="foodTransformation${cropIndex}" class="form-label">Food Transformation for ${crop.crop}</label>
          <input type="text" class="form-control" id="foodTransformation${cropIndex}">
          <label for="destination${cropIndex}" class="form-label">Destination for ${crop.crop}</label>
          <input type="text" class="form-control" id="destination${cropIndex}">
        `;
        additionalDetailsContainer.appendChild(detailsDiv);
      });
    }

    function showPhase(phase) {
      currentPhase = phase;
      document.getElementById('phase-1').classList.toggle('hidden', phase !== 1);
      document.getElementById('phase-2').classList.toggle('hidden', phase !== 2);
      document.getElementById('phase-3').classList.toggle('hidden', phase !== 3);
    }

    function savePhase(phase) {
      if (phase === 1) {
        collectPhase1Data();
      } else if (phase === 2) {
        collectPhase2Data();
      } else if (phase === 3) {
        for (let i = 1; i <= cropCount; i++) {
          if (harvestData.crops[i-1]) {
            harvestData.crops[i-1].foodTransformation = document.getElementById(`foodTransformation${i}`).value;
            harvestData.crops[i-1].destination = document.getElementById(`destination${i}`).value;
          }
        }
      }
      const hgId = harvestData.harvestdate + '-' + harvestData.source;
      google.script.run.saveHarvestData(hgId, harvestData, phase);
    }
  </script>
</body>
</html>