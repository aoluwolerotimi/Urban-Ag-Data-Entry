<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Harvest Tracking</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .hidden {
      display: none;
    }
    .greyed-out {
      color: grey;
      font-style: italic;
    }
    body {
      font-size: 1.2rem; 
    }
    h1 {
      color: #6E4A98;
    }
    .btn-primary {
      background-color: #6E4A98;
      border-color: #6E4A98;
    }
    .btn-primary:hover {
      background-color: #563D7C;
      border-color: #563D7C;
    }
    .container {
      padding: 15px;
    }
    .form-control, .btn {
      width: 100%;
    }
    .mb-3 {
      margin-bottom: 15px;
    }
    .btn {
      margin-bottom: 15px; 
    }
    @media (max-width: 576px) {
      h1 {
        font-size: 1.5rem;
      }
      .container {
        padding: 5px;
      }
    }
  </style>


  <!-- <style>
    .hidden {
      display: none;
    }
    .greyed-out {
      color: grey;
      font-style: italic;
    }
    h1 {
      color: #6E4A98;
    }
    .btn-primary {
      background-color: #6E4A98;
      border-color: #6E4A98;
    }
    .btn-primary:hover {
      background-color: #563D7C;
      border-color: #563D7C;
    }
  </style> -->
</head>

<body>
  <div class="container">
    <h1>Innovation Jeunes Onsite Harvest Tracking</h1>


    <!-- Phase 1: Basic Details -->
    <div id="phase-1">
      <h2>Basic Details</h2>
      <div class="mb-3">
          <label for="lookup-date" class="form-label">Enter Harvest Date to Find Entries</label>
          <input type="date" class="form-control" id="lookup-date">
      </div>
      <div class="mb-3">
        <label for="lookup-source" class="form-label">Select Source to Find Entries</label>
        <select class="form-control" id="lookup-source">
          <option value="" disabled selected>Select Source</option>
          <option value="Cabot">Cabot</option>
          <option value="Cathedrale">Cathedrale</option>
          <option value="Concordia">Concordia</option>
          <option value="Delta">Delta</option>
          <option value="Evangel">Evangel</option>
          <option value="Hawarden">Hawarden</option>
          <option value="NWSM">NWSM</option>
          <option value="Versailles">Versailles</option>
          <option value="Unrecorded">Unrecorded</option>
        </select>
      <button class="btn btn-primary mt-3" onclick="lookupEntry()">Lookup</button>
      </div>
      <div class="mb-3">
        <label for="harvestdate" class="form-label">Harvest date*</label>
        <input type="date" class="form-control" id="harvestdate" required>
      </div>
      <div class="mb-3">
        <label for="source" class="form-label">Source*</label>
        <select class="form-control" id="source" required>
          <option value="" disabled selected class = "greyed-out">Select Source</option>
          <option value="Cabot">Cabot</option>
          <option value="Cathedrale">Cathedrale</option>
          <option value="Concordia">Concordia</option>
          <option value="Delta">Delta</option>
          <option value="Evangel">Evangel</option>
          <option value="Hawarden">Hawarden</option>
          <option value="NWSM">NWSM</option>
          <option value="Versailles">Versailles</option>
          <option value="Unrecorded">Unrecorded</option>
        </select>
      </div>
      <div id="crops-container">
        <div class="crop-entry mb-3">
          <label for="crop1" class="form-label">Crop 1*</label>
          <input type="text" class="form-control" id="crop1" required>
          <label for="comments1" class="form-label">Comments</label>
          <input type="text" class="form-control" id="comments1">
        </div>
      </div>
      <button class="btn btn-secondary" onclick="addCrop()">Add Another Crop</button>
      <button class="btn btn-primary" onclick="savePhase(1)">Save to Sheet</button>
      <button class="btn btn-primary" onclick="nextPhase()">Continue</button>
    </div>

    <!-- Phase 2: Weight Details -->
    <div id="phase-2" class="hidden">
      <h2>Weight Details</h2>
      <div id="weights-container"></div>
      <button class="btn btn-secondary" onclick="previousPhase()">Back</button>
      <button class="btn btn-primary" onclick="savePhase(2)">Save to Sheet</button>
      <button class="btn btn-primary" onclick="nextPhase()">Continue</button>
    </div>

    <!-- Phase 3: Additional Details -->
    <div id="phase-3" class="hidden">
      <h2>Additional Details</h2>
      <div id="additional-details-container"></div>
      <button class="btn btn-secondary" onclick="previousPhase()">Back</button>
      <button class="btn btn-primary" onclick="savePhase(3)">Save to Sheet</button>
    </div>
  </div>
  <script>
    let cropCount = 1;
    let currentPhase = 1;
    let harvestData = {
      harvestdate: '',
      source: '',
      crops: []
    };

    function addCrop() {
      cropCount++;
      const cropsContainer = document.getElementById('crops-container');
      const newCropDiv = document.createElement('div');
      newCropDiv.className = 'crop-entry mb-3';
      newCropDiv.innerHTML = `
        <label for="crop${cropCount}" class="form-label">Crop ${cropCount}</label>
        <input type="text" class="form-control" id="crop${cropCount}">
        <label for="comments${cropCount}" class="form-label">Comments</label>
        <input type="text" class="form-control" id="comments${cropCount}">
      `;
      cropsContainer.appendChild(newCropDiv);
    }



// with phase 1  check to prevent duplicate IDs
    function nextPhase() {
      const harvestDate = document.getElementById('harvestdate').value;
      const source = document.getElementById('source').value;
      const crop1 = document.getElementById('crop1').value;
      if (!harvestDate || !source || !crop1) {
        alert("Please enter Harvest Date, Source, and at least one Crop.");
        return;
      }

      const hgId = harvestDate + '-' + source;
      google.script.run.withSuccessHandler((exists) => {
        if (exists) {
          alert("Existing entry found for this date and source. Please look it up above to continue editing");
        } else {
          if (currentPhase === 1) {
            if (harvestData.crops.length > 0) {
              renderPhase2(harvestData);
              showPhase(2);
            } else {
              collectPhase1Data();
              showPhase(2);
            }
          } else if (currentPhase === 2) {
            if (harvestData.crops.some(crop => crop.weight)) {
              renderPhase3();
              showPhase(3);
            } else {
              collectPhase2Data();
              showPhase(3);
            }
          }
        }
      }).checkHgIdExists(hgId);
    }


    function previousPhase() {
      if (currentPhase === 2) {
        showPhase(1);
      } else if (currentPhase === 3) {
        showPhase(2);
      }
    }

    function collectPhase1Data() {
      harvestData.harvestdate = document.getElementById('harvestdate').value;
      harvestData.source = document.getElementById('source').value;
      harvestData.crops = [];
      for (let i = 1; i <= cropCount; i++) {
        const crop = document.getElementById(`crop${i}`).value;
        const comments = document.getElementById(`comments${i}`).value;
        if (crop) {
          harvestData.crops.push({ crop, comments, weight: '', foodTransformation: '', destination: '' });
        }
      }
      renderPhase2();
    }

    function collectPhase2Data() {
      for (let i = 1; i <= cropCount; i++) {
        const weight = document.getElementById(`weight${i}`).value;
        if (harvestData.crops[i-1]) {
          harvestData.crops[i-1].weight = weight;
        }
      }
      renderPhase3();
    }


function collectAllData() {
  // Collect data from Phase 1
  harvestData.harvestdate = document.getElementById('harvestdate').value;
  harvestData.source = document.getElementById('source').value;
  harvestData.crops = [];
  for (let i = 1; i <= cropCount; i++) {
    const crop = document.getElementById(`crop${i}`).value;
    const comments = document.getElementById(`comments${i}`).value;
    if (crop) {
      harvestData.crops.push({ crop, comments, weight: '', foodTransformation: '', destination: '' });
    }
  }

  // Collect data from Phase 2, if the elements exist
  for (let i = 1; i <= cropCount; i++) {
    const weightElement = document.getElementById(`weight${i}`);
    if (weightElement && harvestData.crops[i-1]) {
      const weight = weightElement.value;
      harvestData.crops[i-1].weight = weight;
    }
  }

  // Collect data from Phase 3, if the elements exist
  for (let i = 1; i <= cropCount; i++) {
    const foodTransformationElement = document.getElementById(`foodTransformation${i}`);
    const destinationElement = document.getElementById(`destination${i}`);
    if (foodTransformationElement && destinationElement && harvestData.crops[i-1]) {
      harvestData.crops[i-1].foodTransformation = foodTransformationElement.value;
      harvestData.crops[i-1].destination = destinationElement.value;
    }
  }
}

    
    function renderPhase2() {
      const weightsContainer = document.getElementById('weights-container');
      weightsContainer.innerHTML = ''; 
      harvestData.crops.forEach((crop, index) => {
        const cropIndex = index + 1;
        const weightDiv = document.createElement('div');
        weightDiv.className = 'mb-3';
        weightDiv.innerHTML = ` 
          <label for="weight${cropIndex}" class="form-label">Weight (g) for ${crop.crop}</label>
          <input type="number" class="form-control" id="weight${cropIndex}" min="1" value="${crop.weight || ''}">
        `; // checks if data already exists. If so, inserts it. Else, inserts empty string
        weightsContainer.appendChild(weightDiv);
      }); 
    }

    function renderPhase3() {
      const additionalDetailsContainer = document.getElementById('additional-details-container');
      additionalDetailsContainer.innerHTML = ''; 
      harvestData.crops.forEach((crop, index) => {
        const cropIndex = index + 1;
        const detailsDiv = document.createElement('div');
        detailsDiv.className = 'mb-3';
        detailsDiv.innerHTML = `
          <label for="foodTransformation${cropIndex}" class="form-label">Food Transformation for ${crop.crop}</label>
          <select class="form-control" id="foodTransformation${cropIndex}">
            <option value="" disabled selected class = "greyed-out">Select Food Transformation</option>
            <option value="None" ${crop.foodTransformation === "None" ? "selected" : ""}>None</option>
            <option value="Catering" ${crop.foodTransformation === "Catering" ? "selected" : ""}>Catering</option>
            <option value="Dried" ${crop.foodTransformation === "Dried" ? "selected" : ""}>Dried</option>
            <option value="Jammed" ${crop.foodTransformation === "Jammed" ? "selected" : ""}>Jammed</option>
            <option value="Pickled" ${crop.foodTransformation === "Pickled" ? "selected" : ""}>Pickled</option>
            <option value="Syrup" ${crop.foodTransformation === "Syrup" ? "selected" : ""}>Syrup</option>
            <option value="Unspecified" ${crop.foodTransformation === "Unspecified" ? "selected" : ""}>Unspecified</option>
          </select>
          <label for="destination${cropIndex}" class="form-label">Destination for ${crop.crop}</label>
          <select class="form-control" id="destination${cropIndex}">
            <option value="" disabled selected class="greyed-out">Select Destination</option>
            <option value="Innov. Assistance (IA)" ${crop.destination === "Innov. Assistance (IA)" ? "selected" : ""}>Innov. Assistance (IA)</option>
            <option value="Food Transformation" ${crop.destination === "Food Transformation" ? "selected" : ""}>Food Transformation</option>
            <option value="NWSM" ${crop.destination === "NWSM" ? "selected" : ""}>NWSM</option>
            <option value="Summit" ${crop.destination === "Summit" ? "selected" : ""}>Summit</option>
            <option value="Evangel" ${crop.destination === "Evangel" ? "selected" : ""}>Evangel</option>
            <option value="Volunteer/ Intern" ${crop.destination === "Volunteer/ Intern" ? "selected" : ""}>Volunteer/ Intern</option>
            <option value="Gift" ${crop.destination === "Gift" ? "selected" : ""}>Gift</option>
            <option value="Urban Agric. (UA)" ${crop.destination === "Urban Agric. (UA)" ? "selected" : ""}>Urban Agric. (UA)</option>
            <option value="Unrecorded" ${crop.destination === "Unrecorded" ? "selected" : ""}>Unrecorded</option>
          </select>
        `;
        additionalDetailsContainer.appendChild(detailsDiv);
      });
    }

    function showPhase(phase) {
      currentPhase = phase;
      document.getElementById('phase-1').classList.toggle('hidden', phase !== 1);
      document.getElementById('phase-2').classList.toggle('hidden', phase !== 2);
      document.getElementById('phase-3').classList.toggle('hidden', phase !== 3);
    } 

// with checking to ensure source and date + duplicate check
function savePhase(phase) {
  const harvestDate = document.getElementById('harvestdate').value;
  const source = document.getElementById('source').value;
  const crop1 = document.getElementById('crop1').value;

  if (!harvestDate || !source || !crop1) {
    alert("Please enter Harvest Date, Source, and at least one Crop.");
    return;
  }

  const hgId = harvestDate + '-' + source;
  google.script.run.withSuccessHandler((exists) => {
    if (exists) {
      alert("Existing entry found. Please use the lookup functionality to retrieve and edit the existing data.");
    } else {
      // Collect all data from all phases
      collectAllData();
      google.script.run
        .withSuccessHandler(() => {
          alert('Data saved. Refresh page to start form again.');
        })
        .saveHarvestData(hgId, harvestData, phase);
    }
  }).checkHgIdExists(hgId);
}


    function lookupEntry() {
      const lookupDate = document.getElementById('lookup-date').value;
      const lookupSource = document.getElementById('lookup-source').value;

      if (!lookupDate || !lookupSource) {
        alert('Please enter both the harvest date and source.');
        return;
      }

      const hgId = `${lookupDate}-${lookupSource}`;
      google.script.run.withSuccessHandler(populateForm).lookupHarvestData(hgId);
    }


    function populateForm(data) {
      if (!data) {
        alert('No entry found with the given Harvest Group ID.');
        return;
      }
      document.getElementById('harvestdate').value = data.harvestdate;
      document.getElementById('source').value = data.source;
      cropCount = data.crops.length;
      document.getElementById('crops-container').innerHTML = '';
      data.crops.forEach((crop, index) => {
        const cropIndex = index + 1;
        const cropDiv = document.createElement('div');
        cropDiv.className = 'crop-entry mb-3';
        cropDiv.innerHTML = `
          <label for="crop${cropIndex}" class="form-label">Crop ${cropIndex}</label>
          <input type="text" class="form-control" id="crop${cropIndex}" value="${crop.crop}">
          <label for="comments${cropIndex}" class="form-label">Comments</label>
          <input type="text" class="form-control" id="comments${cropIndex}" value="${crop.comments}">
        `;
        document.getElementById('crops-container').appendChild(cropDiv);
      });
      harvestData = data; // Set the retrieved data to harvestData
      renderPhase2(harvestData);
      data.crops.forEach((crop, index) => {
        const cropIndex = index + 1;
        document.getElementById(`weight${cropIndex}`).value = crop.weight;
      });
      renderPhase3();
      data.crops.forEach((crop, index) => {
        const cropIndex = index + 1;
        document.getElementById(`foodTransformation${cropIndex}`).value = crop.foodTransformation;
        document.getElementById(`destination${cropIndex}`).value = crop.destination;
      });
      showPhase(1);  // Ensure to show the first phase with populated data
    }
  </script>
</body>

</html>